<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TAKA GAME v4.0 - Strategic Board Game</title>
    <link rel="icon" href="TAKAGAMEicon.jpg">
    <style>
        :root {
            --primary: #ff6b6b;
            --secondary: #4ecdc4;
            --accent: #667eea;
            --gold: #ffd700;
            --dark-bg: #0a0a0a;
            --dark-card: #1a1a2e;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
        }
        #logoScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100vh;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            display: flex; justify-content: center; align-items: center;
            z-index: 10000; transition: opacity 1s ease;
        }
        #logoScreen.hide { opacity: 0; pointer-events: none; }
        .logo-content { text-align: center; animation: logoFadeIn 1.5s ease-out; }
        .logo-img { max-width: 90%; max-height: 70vh; object-fit: contain; filter: drop-shadow(0 20px 60px rgba(0, 0, 0, 0.5)); }
        @keyframes logoFadeIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
        #backButton {
            position: fixed; top: 20px; left: 20px;
            background: rgba(0, 0, 0, 0.5); color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 12px 25px; border-radius: 50px;
            cursor: pointer; font-size: 1.1em; z-index: 1000;
            transition: all 0.3s ease; backdrop-filter: blur(10px);
        }
        #backButton:hover { background: rgba(255, 255, 255, 0.2); transform: scale(1.05); }
        .rules-toggle-btn {
            position: fixed; top: 80px; right: 20px;
            background: rgba(255, 215, 0, 0.3); color: white;
            border: 2px solid var(--gold); padding: 12px 25px;
            border-radius: 50px; cursor: pointer; font-size: 1.1em;
            z-index: 1000; transition: all 0.3s ease; backdrop-filter: blur(10px);
        }
        .rules-toggle-btn:hover { background: rgba(255, 215, 0, 0.5); transform: scale(1.05); }
        .screen { display: none; min-height: 100vh; padding: 20px; }
        .screen.active { display: block; animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .rules-panel {
            display: none; position: fixed; top: 0; right: -500px;
            width: 500px; height: 100vh;
            background: linear-gradient(180deg, var(--dark-card) 0%, #16213e 100%);
            padding: 80px 30px 30px; z-index: 999; overflow-y: auto;
            box-shadow: -5px 0 30px rgba(0, 0, 0, 0.7);
            transition: right 0.3s ease;
        }
        .rules-panel.active { display: block; right: 0; }
        .rules-panel h2 { font-size: 2em; margin-bottom: 20px; color: var(--gold); }
        .rules-panel h3 { font-size: 1.5em; margin: 20px 0 10px 0; color: var(--secondary); }
        .rules-panel p, .rules-panel li { font-size: 1.1em; line-height: 1.8; margin: 10px 0; color: rgba(255, 255, 255, 0.9); }
        .rules-panel ul { margin-left: 20px; }
        .menu-container { max-width: 1200px; margin: 0 auto; padding: 80px 20px 40px; }
        .menu-header { text-align: center; margin-bottom: 50px; }
        .game-logo-img { max-width: 500px; width: 90%; margin: 0 auto 30px; filter: drop-shadow(0 10px 40px rgba(0, 0, 0, 0.3)); }
        .difficulty-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px; margin-bottom: 40px; }
        .difficulty-card {
            background: rgba(255, 255, 255, 0.15); border-radius: 20px;
            padding: 30px; cursor: pointer; transition: all 0.3s ease;
            border: 3px solid transparent;
        }
        .difficulty-card:hover { transform: translateY(-8px); box-shadow: 0 20px 50px rgba(0, 0, 0, 0.4); border-color: rgba(255, 255, 255, 0.5); }
        .difficulty-card.selected { border-color: var(--gold); box-shadow: 0 10px 30px rgba(255, 215, 0, 0.5); }
        .difficulty-card h3 { font-size: 1.8em; margin-bottom: 15px; text-align: center; }
        .difficulty-info { color: rgba(255, 255, 255, 0.9); line-height: 1.6; margin: 8px 0; padding-left: 10px; border-left: 3px solid rgba(255, 255, 255, 0.3); font-size: 0.95em; }
        .settings-panel { background: rgba(0, 0, 0, 0.3); padding: 40px; border-radius: 20px; margin-top: 40px; }
        .settings-panel h3 { text-align: center; margin-bottom: 30px; font-size: 2em; }
        .setting-group { margin-bottom: 25px; }
        .setting-group label { display: block; margin-bottom: 10px; font-size: 1.2em; font-weight: bold; }
        .setting-group input[type="text"], .setting-group input[type="number"] {
            width: 100%; padding: 15px; border-radius: 10px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1); color: white; font-size: 1.1em;
        }
        .setting-group input:focus { outline: none; border-color: var(--gold); }
        .mode-buttons { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin: 15px 0; }
        .mode-btn {
            padding: 18px; background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 15px; color: white; font-size: 1.1em;
            cursor: pointer; transition: all 0.3s ease;
        }
        .mode-btn:hover { background: rgba(255, 255, 255, 0.3); transform: scale(1.05); }
        .mode-btn.selected { background: rgba(255, 215, 0, 0.3); border-color: var(--gold); }
        .start-game-btn {
            width: 100%; padding: 20px;
            background: linear-gradient(135deg, var(--gold) 0%, #ffa500 100%);
            border: none; border-radius: 15px; color: #333;
            font-size: 1.5em; font-weight: bold; cursor: pointer;
            margin-top: 30px; transition: all 0.3s ease;
        }
        .start-game-btn:hover { transform: scale(1.02); box-shadow: 0 10px 40px rgba(255, 215, 0, 0.5); }
        .game-container { max-width: 1600px; margin: 0 auto; padding: 80px 20px 40px; }
        .game-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px; }
        .player-info {
            background: rgba(0, 0, 0, 0.4); padding: 20px 25px;
            border-radius: 15px; flex: 1; min-width: 220px;
        }
        .player-info.active-player {
            border: 3px solid var(--gold);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
            animation: activePlayerPulse 2s ease-in-out infinite;
        }
        @keyframes activePlayerPulse {
            0%, 100% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.5); }
            50% { box-shadow: 0 0 30px rgba(255, 215, 0, 0.8); }
        }
        .player-info h3 { font-size: 1.6em; margin-bottom: 12px; }
        .score-display { font-size: 1.2em; margin: 6px 0; }
        .special-power {
            margin-top: 12px; padding: 12px;
            background: rgba(255, 215, 0, 0.2);
            border-radius: 10px; border: 2px solid var(--gold);
        }
        .special-power-bar {
            width: 100%; height: 16px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px; overflow: hidden; margin: 8px 0;
        }
        .special-power-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--gold) 0%, #ffa500 100%);
            transition: width 0.3s ease;
        }
        .use-special-btn {
            width: 100%; padding: 8px;
            background: linear-gradient(135deg, var(--gold) 0%, #ffa500 100%);
            border: none; border-radius: 8px; color: #333;
            font-size: 1em; font-weight: bold; cursor: pointer;
            transition: all 0.3s ease;
        }
        .use-special-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .use-special-btn:not(:disabled):hover { transform: scale(1.05); }
        .timer-display {
            background: rgba(0, 0, 0, 0.4); padding: 15px;
            border-radius: 15px; text-align: center; min-width: 180px;
        }
        .timer-display.warning { animation: timerWarning 1s ease-in-out infinite; }
        @keyframes timerWarning {
            0%, 100% { background: rgba(255, 0, 0, 0.3); }
            50% { background: rgba(255, 0, 0, 0.6); }
        }
        .current-turn {
            background: rgba(255, 215, 0, 0.3); padding: 15px;
            border-radius: 15px; text-align: center; min-width: 220px;
            border: 3px solid var(--gold);
        }
        .current-turn h3 { font-size: 1.3em; margin-bottom: 8px; }
        .grid-container { display: flex; gap: 25px; margin: 25px 0; flex-wrap: wrap; justify-content: center; }
        .letter-selector { background: rgba(0, 0, 0, 0.4); padding: 20px; border-radius: 15px; min-width: 130px; }
        .letter-selector h4 { text-align: center; margin-bottom: 15px; font-size: 1.2em; }
        .letter-btn {
            width: 100%; padding: 15px; margin: 8px 0;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px; color: white; font-size: 1.8em;
            font-weight: bold; cursor: pointer; transition: all 0.3s ease;
        }
        .letter-btn:hover:not(:disabled) { background: rgba(255, 255, 255, 0.3); transform: scale(1.05); }
        .letter-btn.selected { background: rgba(255, 215, 0, 0.4); border-color: var(--gold); }
        .letter-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        #gameGrid {
            background: rgba(0, 0, 0, 0.4); padding: 15px;
            border-radius: 20px; display: inline-block;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.5);
        }
        .grid {
            display: grid; gap: 3px;
            background: rgba(255, 255, 255, 0.1);
            padding: 3px; border-radius: 10px;
        }
        .cell {
            width: 60px; height: 60px;
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px; display: flex;
            justify-content: center; align-items: center;
            font-size: 2.2em; font-weight: bold;
            cursor: pointer; transition: all 0.2s ease;
        }
        .cell:hover:not(.occupied) { background: rgba(255, 255, 255, 0.3); transform: scale(1.05); }
        .cell.occupied { cursor: not-allowed; }
        .cell.team1 { background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); color: white; }
        .cell.team2 { background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%); color: white; }
        .cell.neutral { background: linear-gradient(135deg, #ffd700 0%, #ffa500 100%); color: #333; }
        .controls { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; margin-top: 25px; }
        .control-btn {
            padding: 14px 28px; border: none; border-radius: 12px;
            font-size: 1.1em; font-weight: bold; cursor: pointer;
            transition: all 0.3s ease; color: white;
        }
        .btn-undo { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .btn-hint { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .btn-save { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .btn-load { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        .btn-end { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        .btn-menu { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .control-btn:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3); }
        .control-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .hint-panel {
            background: rgba(0, 0, 0, 0.4); padding: 20px;
            border-radius: 15px; margin: 20px auto;
            max-width: 800px; border: 2px solid var(--accent);
        }
        .hint-panel h4 { font-size: 1.5em; margin-bottom: 15px; color: var(--gold); }
        .hint-item {
            background: rgba(255, 255, 255, 0.1); padding: 15px;
            border-radius: 10px; margin: 10px 0;
            border-left: 4px solid var(--accent);
        }
        .modal {
            display: none; position: fixed; top: 0; left: 0;
            width: 100%; height: 100vh;
            background: rgba(0, 0, 0, 0.9); z-index: 5000;
            justify-content: center; align-items: center;
        }
        .modal.active { display: flex; animation: fadeIn 0.3s ease-out; }
        .modal-content {
            background: linear-gradient(135deg, var(--dark-card) 0%, #16213e 100%);
            padding: 45px; border-radius: 30px; max-width: 650px;
            width: 90%; box-shadow: 0 30px 80px rgba(0, 0, 0, 0.7);
            border: 3px solid var(--gold);
        }
        .modal-content h2 { font-size: 2.8em; text-align: center; margin-bottom: 25px; color: var(--gold); }
        .modal-content p { font-size: 1.4em; text-align: center; margin: 18px 0; }
        .modal-buttons { display: flex; gap: 18px; margin-top: 35px; }
        .modal-btn {
            flex: 1; padding: 16px; border: none;
            border-radius: 12px; font-size: 1.2em;
            font-weight: bold; cursor: pointer;
            transition: all 0.3s ease; color: white;
        }
        .btn-primary { background: linear-gradient(135deg, var(--gold) 0%, #ffa500 100%); color: #333; }
        .btn-secondary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .modal-btn:hover { transform: scale(1.05); }
        .toast {
            position: fixed; bottom: 30px; left: 50%;
            transform: translateX(-50%) translateY(150px);
            background: rgba(0, 0, 0, 0.9); color: white;
            padding: 18px 35px; border-radius: 50px;
            font-size: 1.1em; z-index: 6000;
            transition: transform 0.3s ease; border: 2px solid;
        }
        .toast.show { transform: translateX(-50%) translateY(0); }
        .toast.success { border-color: #56ab2f; }
        .toast.warning { border-color: #ffa500; }
        .toast.error { border-color: #ff6b6b; }
        .toast.info { border-color: #4ecdc4; }
        .toast.achievement { border-color: var(--gold); background: linear-gradient(135deg, var(--gold) 0%, #ffa500 50%); color: #333; font-weight: bold; }
        @media (max-width: 768px) {
            .cell { width: 45px; height: 45px; font-size: 1.6em; }
            .game-header { flex-direction: column; }
            .control-btn { font-size: 0.95em; padding: 11px 20px; }
            .modal-content { padding: 28px; }
            .modal-content h2 { font-size: 2em; }
            .rules-panel { width: 100%; right: -100%; }
        }
    </style>
</head>
<body>
    <div id="logoScreen">
        <div class="logo-content">
            <img src="TAKAGAME.png" alt="TAKA GAME" class="logo-img">
        </div>
    </div>
    <button id="backButton" onclick="window.location.href='index.html'" style="display: none;">â† MeruHubã«æˆ»ã‚‹</button>
    <button class="rules-toggle-btn" id="rulesToggleBtn" onclick="toggleRules()" style="display: none;">ğŸ“– ãƒ«ãƒ¼ãƒ«</button>
    <div class="rules-panel" id="rulesPanel">
        <h2>ğŸ“– TAKA GAME ãƒ«ãƒ¼ãƒ«</h2>
        <h3>ğŸ¯ ã‚²ãƒ¼ãƒ ã®ç›®çš„</h3>
        <p>ã€ŒTAKAã€ã€ŒAKATã€ã‚’ç¸¦ãƒ»æ¨ªãƒ»æ–œã‚ã«å®Œæˆã•ã›ã¦ãƒã‚¤ãƒ³ãƒˆã‚’ç²å¾—ã€‚æœ€çµ‚çš„ã«ãƒã‚¤ãƒ³ãƒˆãŒå¤šã„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒå‹åˆ©ï¼</p>
        <h3>ğŸ“‹ åŸºæœ¬ãƒ«ãƒ¼ãƒ«</h3>
        <ul>
            <li>äº¤äº’ã«ã‚¿ãƒ¼ãƒ³ã‚’è¡Œã†</li>
            <li>ä¸¡ã‚µã‚¤ãƒ‰ã‹ã‚‰ã€ŒTã€ã€ŒAã€ã€ŒKã€ã‚’é¸æŠã—ã¦é…ç½®</li>
            <li>ã€ŒTAKAã€ã€ŒAKATã€å®Œæˆ: 3ãƒã‚¤ãƒ³ãƒˆ</li>
            <li>ã€ŒTAKã€ã€ŒKATã€å®Œæˆ: 1ãƒã‚¤ãƒ³ãƒˆ</li>
            <li>å®Œæˆæ™‚ã€ãƒœãƒ¼ãƒŠã‚¹ã‚¿ãƒ¼ãƒ³ã§ã‚‚ã†1å€‹ç½®ã‘ã‚‹</li>
            <li>ä¸­å¤®ã®ã€ŒTã€ã¯èª°ã§ã‚‚ä½¿ãˆã‚‹å…±ç”¨é§’</li>
        </ul>
        <h3>âš¡ å¿…æ®ºæŠ€ã‚·ã‚¹ãƒ†ãƒ </h3>
        <ul>
            <li>7ã‚¿ãƒ¼ãƒ³ã”ã¨ã«æŠ€ãŒå¤‰åŒ–</li>
            <li><strong>è‡ªåˆ†ã®ã‚¿ãƒ¼ãƒ³ã‚’æ¶ˆè²»ã—ã¦ç™ºå‹•</strong></li>
            <li>æŠ€ä½¿ç”¨å¾Œã¯ç›¸æ‰‹ã®ã‚¿ãƒ¼ãƒ³ã«ãªã‚‹</li>
            <li>å„7ã‚¿ãƒ¼ãƒ³æœŸé–“ä¸­ã«1å›ã ã‘ä½¿ç”¨å¯èƒ½</li>
            <li>é§’å¤‰æ›ï¼šç›¸æ‰‹ã®é§’1ã¤ã‚’è‡ªåˆ†ã®é§’ã«å¤‰ãˆã‚‹</li>
        </ul>
        <h3>ğŸ® é›£æ˜“åº¦</h3>
        <ul>
            <li>ğŸŸ¢ CORE (9Ã—9): åˆå¿ƒè€…å‘ã‘ã€åŸºæœ¬ãƒ«ãƒ¼ãƒ«</li>
            <li>ğŸ”µ LIGHT (9Ã—9): æ¨™æº–ãƒ¢ãƒ¼ãƒ‰</li>
            <li>ğŸŸ¡ NORMAL (9Ã—9): ä¸­ç´šè€…å‘ã‘</li>
            <li>ğŸŸ  HARD (9Ã—9): ä¸Šç´šè€…å‘ã‘</li>
            <li>ğŸ”´ ULTIMATE (11Ã—11): N,Eè¿½åŠ ã€ã€ŒNOGUCHIã€å®Œæˆã§5ãƒã‚¤ãƒ³ãƒˆ (7æ–‡å­—)</li>
            <li>âš« LEGEND (9Ã—9): 5ã‚¿ãƒ¼ãƒ³ã”ã¨ã«ç›¤é¢ãŒå›è»¢</li>
        </ul>
        <h3>ğŸ¤– CPUå¯¾æˆ¦</h3>
        <ul>
            <li>ãƒ¬ãƒ™ãƒ«1 (ãƒ©ãƒ³ãƒ€ãƒ ): å®Œå…¨ãƒ©ãƒ³ãƒ€ãƒ ã«é…ç½®</li>
            <li>ãƒ¬ãƒ™ãƒ«2 (é˜²å¾¡å‹): ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å®Œæˆã‚’é˜»æ­¢ã—ã‚ˆã†ã¨ã™ã‚‹</li>
            <li>ãƒ¬ãƒ™ãƒ«3 (æ”»æ’ƒå‹): è‡ªåˆ†ã®å®Œæˆã‚’å„ªå…ˆçš„ã«ç‹™ã†</li>
        </ul>
        <h3>ğŸ’¡ æˆ¦ç•¥ã®ã‚³ãƒ„</h3>
        <ul>
            <li>å…ˆèª­ã¿ã—ã¦ç›¸æ‰‹ã®å®Œæˆã‚’é˜»æ­¢</li>
            <li>1æ‰‹ã§è¤‡æ•°ã®ä¸¦ã³ã‚’ä½œã‚‹</li>
            <li>å¿…æ®ºæŠ€ã‚’åŠ¹æœçš„ã«ä½¿ã†ï¼ˆã‚¿ãƒ¼ãƒ³æ¶ˆè²»ã«æ³¨æ„ï¼‰</li>
            <li>ä¸­å¤®ã®å…±ç”¨Tã‚’æ´»ç”¨ã™ã‚‹</li>
            <li>ãƒœãƒ¼ãƒŠã‚¹ã‚¿ãƒ¼ãƒ³ã‚’ç‹™ã†</li>
            <li>ãƒ’ãƒ³ãƒˆæ©Ÿèƒ½ã§æ”»æ’ƒãƒ»é˜²å¾¡ãƒã‚¤ãƒ³ãƒˆã‚’ç¢ºèª</li>
        </ul>
    </div>
    <div id="menuScreen" class="screen">
        <div class="menu-container">
            <div class="menu-header">
                <img src="TAKAGAME.png" alt="TAKA GAME" class="game-logo-img">
                <h1 style="font-size: 3em; margin-top: 20px;">Welcome to TAKA GAME v4.0</h1>
                <p style="font-size: 1.3em; margin-top: 15px; color: rgba(255, 255, 255, 0.8);">æˆ¦ç•¥çš„ãƒœãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ  - ç©¶æ¥µã®ãƒã‚¤ãƒ³ãƒˆåˆ¶ãƒãƒˆãƒ«</p>
            </div>
            <h2 style="text-align: center; font-size: 2.5em; margin-bottom: 30px;">é›£æ˜“åº¦ã‚’é¸æŠ</h2>
            <div class="difficulty-grid">
                <div class="difficulty-card" onclick="selectDifficulty('core')">
                    <h3>ğŸŸ¢ CORE</h3>
                    <div class="difficulty-info">ç›¤é¢: 9Ã—9</div>
                    <div class="difficulty-info">æ–‡å­—: T, A, K</div>
                    <div class="difficulty-info">åˆå¿ƒè€…å‘ã‘</div>
                </div>
                <div class="difficulty-card" onclick="selectDifficulty('light')">
                    <h3>ğŸ”µ LIGHT</h3>
                    <div class="difficulty-info">ç›¤é¢: 9Ã—9</div>
                    <div class="difficulty-info">æ–‡å­—: T, A, K</div>
                    <div class="difficulty-info">æ¨™æº–ãƒ¢ãƒ¼ãƒ‰</div>
                </div>
                <div class="difficulty-card" onclick="selectDifficulty('normal')">
                    <h3>ğŸŸ¡ NORMAL</h3>
                    <div class="difficulty-info">ç›¤é¢: 9Ã—9</div>
                    <div class="difficulty-info">æ–‡å­—: T, A, K</div>
                    <div class="difficulty-info">ä¸­ç´šè€…å‘ã‘</div>
                </div>
                <div class="difficulty-card" onclick="selectDifficulty('hard')">
                    <h3>ğŸŸ  HARD</h3>
                    <div class="difficulty-info">ç›¤é¢: 9Ã—9</div>
                    <div class="difficulty-info">æ–‡å­—: T, A, K</div>
                    <div class="difficulty-info">ä¸Šç´šè€…å‘ã‘</div>
                </div>
                <div class="difficulty-card" onclick="selectDifficulty('ultimate')">
                    <h3>ğŸ”´ ULTIMATE</h3>
                    <div class="difficulty-info">ç›¤é¢: 11Ã—11</div>
                    <div class="difficulty-info">æ–‡å­—: T, A, K, N, E</div>
                    <div class="difficulty-info">NOGUCHIå®Œæˆ (7æ–‡å­—5pt)</div>
                </div>
                <div class="difficulty-card" onclick="selectDifficulty('legend')">
                    <h3>âš« LEGEND</h3>
                    <div class="difficulty-info">ç›¤é¢: 9Ã—9</div>
                    <div class="difficulty-info">5ã‚¿ãƒ¼ãƒ³ã”ã¨ã«å›è»¢</div>
                    <div class="difficulty-info">æœ€é«˜é›£åº¦</div>
                </div>
            </div>
        </div>
    </div>
    <div id="settingsScreen" class="screen">
        <div class="menu-container">
            <div class="settings-panel">
                <h3>âš™ï¸ ã‚²ãƒ¼ãƒ è¨­å®š</h3>
                <div class="setting-group">
                    <label>ãƒãƒ¼ãƒ 1ã®åå‰</label>
                    <input type="text" id="team1Name" value="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1" placeholder="ãƒãƒ¼ãƒ 1ã®åå‰">
                </div>
                <div class="setting-group">
                    <label>ãƒãƒ¼ãƒ 2ã®åå‰</label>
                    <input type="text" id="team2Name" value="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2" placeholder="ãƒãƒ¼ãƒ 2ã®åå‰">
                </div>
                <div class="setting-group">
                    <label>å¯¾æˆ¦ãƒ¢ãƒ¼ãƒ‰</label>
                    <div class="mode-buttons">
                        <button class="mode-btn selected" onclick="selectMode('pvp')">å¯¾äººæˆ¦</button>
                        <button class="mode-btn" onclick="selectMode('cpu')">CPUå¯¾æˆ¦</button>
                    </div>
                </div>
                <div class="setting-group" id="cpuLevelGroup" style="display: none;">
                    <label>CPUé›£æ˜“åº¦</label>
                    <div class="mode-buttons">
                        <button class="mode-btn cpu-level selected" onclick="selectCPULevel(1)">ãƒ¬ãƒ™ãƒ«1 (ãƒ©ãƒ³ãƒ€ãƒ )</button>
                        <button class="mode-btn cpu-level" onclick="selectCPULevel(2)">ãƒ¬ãƒ™ãƒ«2 (é˜²å¾¡å‹)</button>
                        <button class="mode-btn cpu-level" onclick="selectCPULevel(3)">ãƒ¬ãƒ™ãƒ«3 (æ”»æ’ƒå‹)</button>
                    </div>
                </div>
                <div class="setting-group">
                    <label>è©¦åˆåˆ¶é™æ™‚é–“ (åˆ†) - 0ã§ç„¡åˆ¶é™</label>
                    <input type="number" id="matchTimeLimit" value="0" min="0" max="60">
                </div>
                <div class="setting-group">
                    <label>ã‚¿ãƒ¼ãƒ³åˆ¶é™æ™‚é–“ (ç§’) - 0ã§ç„¡åˆ¶é™</label>
                    <input type="number" id="turnTimeLimit" value="0" min="0" max="300">
                </div>
                <div style="display: flex; gap: 15px;">
                    <button class="start-game-btn" onclick="showScreen('menuScreen')" style="flex: 1; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">â† æˆ»ã‚‹</button>
                    <button class="start-game-btn" onclick="startGame()" style="flex: 2;">ğŸ® ã‚²ãƒ¼ãƒ é–‹å§‹</button>
                </div>
            </div>
        </div>
    </div>
    <div id="gameScreen" class="screen">
        <div class="game-container">
            <div class="game-header">
                <div class="player-info" id="player1Info">
                    <h3 id="team1Display">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1</h3>
                    <div class="score-display">TAKA/AKAT: <span id="p1Taka">0</span></div>
                    <div class="score-display">TAK/KAT: <span id="p1Tak">0</span></div>
                    <div class="score-display" id="p1NoguchiDisplay" style="display: none;">NOGUCHI: <span id="p1Noguchi">0</span></div>
                    <div class="score-display">åˆè¨ˆ: <span id="p1Total">0</span> pt</div>
                    <div class="special-power">
                        <div style="font-weight: bold; margin-bottom: 5px;" id="p1SkillName">âš¡ é§’å¤‰æ›</div>
                        <div class="special-power-bar">
                            <div class="special-power-fill" id="p1SpecialBar" style="width: 0%"></div>
                        </div>
                        <div style="text-align: center; margin: 5px 0; font-size: 0.9em;" id="p1SpecialCount">æº–å‚™ä¸­...</div>
                        <button class="use-special-btn" id="p1SpecialBtn" onclick="useSpecialPower(1)" disabled>å¿…æ®ºæŠ€ (ã‚¿ãƒ¼ãƒ³æ¶ˆè²»)</button>
                    </div>
                </div>
                <div class="timer-display" id="timerDisplay">
                    <div style="font-size: 1.1em; margin-bottom: 8px;">â±ï¸ è©¦åˆæ™‚é–“</div>
                    <div id="matchTimer" style="font-size: 2.2em; font-weight: bold;">âˆ</div>
                    <div style="font-size: 1.1em; margin-top: 12px;">ğŸ• ã‚¿ãƒ¼ãƒ³æ®‹ã‚Š</div>
                    <div id="turnTimer" style="font-size: 1.8em; font-weight: bold;">âˆ</div>
                </div>
                <div class="player-info" id="player2Info">
                    <h3 id="team2Display">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2</h3>
                    <div class="score-display">TAKA/AKAT: <span id="p2Taka">0</span></div>
                    <div class="score-display">TAK/KAT: <span id="p2Tak">0</span></div>
                    <div class="score-display" id="p2NoguchiDisplay" style="display: none;">NOGUCHI: <span id="p2Noguchi">0</span></div>
                    <div class="score-display">åˆè¨ˆ: <span id="p2Total">0</span> pt</div>
                    <div class="special-power">
                        <div style="font-weight: bold; margin-bottom: 5px;" id="p2SkillName">âš¡ é§’å¤‰æ›</div>
                        <div class="special-power-bar">
                            <div class="special-power-fill" id="p2SpecialBar" style="width: 0%"></div>
                        </div>
                        <div style="text-align: center; margin: 5px 0; font-size: 0.9em;" id="p2SpecialCount">æº–å‚™ä¸­...</div>
                        <button class="use-special-btn" id="p2SpecialBtn" onclick="useSpecialPower(2)" disabled>å¿…æ®ºæŠ€ (ã‚¿ãƒ¼ãƒ³æ¶ˆè²»)</button>
                    </div>
                </div>
            </div>
            <div class="current-turn">
                <h3>ç¾åœ¨ã®ã‚¿ãƒ¼ãƒ³</h3>
                <div style="font-size: 1.8em;" id="currentPlayerName">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1</div>
            </div>
            <div class="hint-panel" id="hintPanel" style="display: none;">
                <h4>ğŸ’¡ ãƒ’ãƒ³ãƒˆ</h4>
                <div id="hintContent"></div>
            </div>
            <div class="grid-container">
                <div class="letter-selector" id="letterSelector1">
                    <h4 id="team1SelectorTitle">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1</h4>
                </div>
                <div id="gameGrid">
                    <div class="grid" id="grid"></div>
                </div>
                <div class="letter-selector" id="letterSelector2">
                    <h4 id="team2SelectorTitle">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2</h4>
                </div>
            </div>
            <div class="controls">
                <button class="control-btn btn-undo" id="undoBtn" onclick="undoMove()">â†¶ 1æ‰‹æˆ»ã™</button>
                <button class="control-btn btn-hint" onclick="showAdvancedHint()">ğŸ’¡ ãƒ’ãƒ³ãƒˆ</button>
                <button class="control-btn btn-save" onclick="saveGame()">ğŸ’¾ ä¿å­˜</button>
                <button class="control-btn btn-load" onclick="loadGame()">ğŸ“‚ èª­è¾¼</button>
                <button class="control-btn btn-end" onclick="confirmEndGame()">ğŸ çµ‚äº†</button>
                <button class="control-btn btn-menu" onclick="backToMenu()">ğŸ“‹ ãƒ¡ãƒ‹ãƒ¥ãƒ¼</button>
            </div>
        </div>
    </div>
    <div id="resultModal" class="modal">
        <div class="modal-content">
            <h2 id="resultTitle">çµæœ</h2>
            <p id="resultMessage"></p>
            <div id="resultDetails"></div>
            <div class="modal-buttons">
                <button class="modal-btn btn-primary" onclick="restartGame()">ã‚‚ã†ä¸€åº¦</button>
                <button class="modal-btn btn-secondary" onclick="backToMenu()">é›£æ˜“åº¦é¸æŠ</button>
            </div>
        </div>
    </div>
    <div id="specialModal" class="modal">
        <div class="modal-content">
            <h2>âš¡ å¿…æ®ºæŠ€ç™ºå‹•</h2>
            <p id="specialDescription">ç›¸æ‰‹ã®é§’ã‚’é¸ã‚“ã§ãã ã•ã„</p>
            <p style="font-size: 1.1em; color: var(--gold);" id="specialEffect">
                é¸ã‚“ã é§’ãŒã‚ãªãŸã®é§’ã«å¤‰ã‚ã‚Šã¾ã™ï¼<br>
                â€»æŠ€ä½¿ç”¨å¾Œã¯ç›¸æ‰‹ã®ã‚¿ãƒ¼ãƒ³ã«ãªã‚Šã¾ã™
            </p>
            <div class="modal-buttons">
                <button class="modal-btn btn-secondary" onclick="closeSpecialModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>
    <div id="toast" class="toast"></div>
    <script>
        let gameState = {
            difficulty: null, gridSize: 9, grid: [], currentPlayer: 1,
            team1Name: 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1', team2Name: 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2',
            scores: { team1: { main: 0, sub: 0, noguchi: 0 }, team2: { main: 0, sub: 0, noguchi: 0 } },
            selectedLetter: { team1: 'T', team2: 'T' },
            opponentMode: 'pvp', cpuLevel: 1,
            matchTimeLimit: 0, turnTimeLimit: 0,
            matchTimeRemaining: 0, turnTimeRemaining: 0,
            matchTimerInterval: null, turnTimerInterval: null,
            isGameActive: false, moveHistory: [],
            totalMoves: 0, rotationCount: 0,
            availableLetters: ['T', 'A', 'K'],
            currentSkill: { name: 'é§’å¤‰æ›', effect: 'convert' },
            skillsAvailable: { team1: true, team2: true },
            bonusTurn: false, hintVisible: false,
            specialPowerMode: false, specialPlayerUsing: 0,
            completedPatterns: []
        };
        const skills = [
            { name: 'é§’å¤‰æ›', effect: 'convert' },
            { name: '2é€£é…ç½®', effect: 'double' },
            { name: 'é§’é™¤å»', effect: 'remove' },
            { name: 'å¼·åˆ¶é…ç½®', effect: 'skip' }
        ];
        window.addEventListener('load', function() {
            setTimeout(() => {
                document.getElementById('logoScreen').classList.add('hide');
                showScreen('menuScreen');
            }, 2500);
        });
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            const showBackBtn = screenId !== 'menuScreen';
            const showRulesBtn = screenId === 'gameScreen';
            document.getElementById('backButton').style.display = showBackBtn ? 'block' : 'none';
            document.getElementById('rulesToggleBtn').style.display = showRulesBtn ? 'block' : 'none';
        }
        function toggleRules() {
            document.getElementById('rulesPanel').classList.toggle('active');
        }
        function selectDifficulty(diff) {
            document.querySelectorAll('.difficulty-card').forEach(card => card.classList.remove('selected'));
            event.target.closest('.difficulty-card').classList.add('selected');
            gameState.difficulty = diff;
            const sizes = { 'core': 9, 'light': 9, 'normal': 9, 'hard': 9, 'ultimate': 11, 'legend': 9 };
            gameState.gridSize = sizes[diff];
            if (diff === 'ultimate') {
                gameState.availableLetters = ['T', 'A', 'K', 'N', 'E'];
            } else {
                gameState.availableLetters = ['T', 'A', 'K'];
            }
            showToast(`é›£æ˜“åº¦ ${diff.toUpperCase()} ã‚’é¸æŠ`, 'success');
            setTimeout(() => showScreen('settingsScreen'), 500);
        }
        function selectMode(mode) {
            gameState.opponentMode = mode;
            document.querySelectorAll('.mode-btn:not(.cpu-level)').forEach(btn => btn.classList.remove('selected'));
            event.target.classList.add('selected');
            document.getElementById('cpuLevelGroup').style.display = mode === 'cpu' ? 'block' : 'none';
            document.getElementById('team2Name').value = mode === 'cpu' ? 'CPU' : 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2';
        }
        function selectCPULevel(level) {
            gameState.cpuLevel = level;
            document.querySelectorAll('.cpu-level').forEach(btn => btn.classList.remove('selected'));
            event.target.classList.add('selected');
        }
        function startGame() {
            if (!gameState.difficulty) {
                showToast('é›£æ˜“åº¦ã‚’é¸æŠã—ã¦ãã ã•ã„', 'warning');
                return;
            }
            gameState.team1Name = document.getElementById('team1Name').value || 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1';
            gameState.team2Name = document.getElementById('team2Name').value || 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2';
            gameState.matchTimeLimit = parseInt(document.getElementById('matchTimeLimit').value) * 60;
            gameState.turnTimeLimit = parseInt(document.getElementById('turnTimeLimit').value);
            initializeGame();
            showScreen('gameScreen');
            updateAllUI();
            if (gameState.matchTimeLimit > 0) startMatchTimer();
            if (gameState.turnTimeLimit > 0) startTurnTimer();
            showToast('ã‚²ãƒ¼ãƒ é–‹å§‹ï¼', 'success');
        }
        function initializeGame() {
            gameState.grid = Array(gameState.gridSize).fill().map(() => Array(gameState.gridSize).fill(null));
            const center = Math.floor(gameState.gridSize / 2);
            gameState.grid[center][center] = { letter: 'T', team: 0 };
            gameState.currentPlayer = 1;
            gameState.scores = { team1: { main: 0, sub: 0, noguchi: 0 }, team2: { main: 0, sub: 0, noguchi: 0 } };
            gameState.selectedLetter = { team1: 'T', team2: 'T' };
            gameState.isGameActive = true;
            gameState.moveHistory = [];
            gameState.totalMoves = 0;
            gameState.rotationCount = 0;
            gameState.currentSkill = skills[0];
            gameState.skillsAvailable = { team1: true, team2: true };
            gameState.bonusTurn = false;
            gameState.hintVisible = false;
            gameState.specialPowerMode = false;
            gameState.specialPlayerUsing = 0;
            gameState.matchTimeRemaining = gameState.matchTimeLimit;
            gameState.turnTimeRemaining = gameState.turnTimeLimit;
            gameState.completedPatterns = [];
            const showNoguchi = gameState.difficulty === 'ultimate';
            document.getElementById('p1NoguchiDisplay').style.display = showNoguchi ? 'block' : 'none';
            document.getElementById('p2NoguchiDisplay').style.display = showNoguchi ? 'block' : 'none';
            updateCurrentSkill();
        }
        function updateCurrentSkill() {
            const skillIndex = Math.floor(gameState.totalMoves / 7) % skills.length;
            gameState.currentSkill = skills[skillIndex];
            document.getElementById('p1SkillName').textContent = `âš¡ ${gameState.currentSkill.name}`;
            document.getElementById('p2SkillName').textContent = `âš¡ ${gameState.currentSkill.name}`;
            const turnsUntilChange = 7 - (gameState.totalMoves % 7);
            document.getElementById('p1SpecialCount').textContent = `å¤‰åŒ–ã¾ã§${turnsUntilChange}ã‚¿ãƒ¼ãƒ³`;
            document.getElementById('p2SpecialCount').textContent = `å¤‰åŒ–ã¾ã§${turnsUntilChange}ã‚¿ãƒ¼ãƒ³`;
            const progress = ((gameState.totalMoves % 7) / 7) * 100;
            document.getElementById('p1SpecialBar').style.width = `${progress}%`;
            document.getElementById('p2SpecialBar').style.width = `${progress}%`;
            const p1Available = gameState.skillsAvailable.team1 && gameState.currentPlayer === 1 && !gameState.specialPowerMode;
            const p2Available = gameState.skillsAvailable.team2 && gameState.currentPlayer === 2 && !gameState.specialPowerMode;
            document.getElementById('p1SpecialBtn').disabled = !p1Available;
            document.getElementById('p2SpecialBtn').disabled = !p2Available;
            document.getElementById('p1SpecialBtn').textContent = gameState.skillsAvailable.team1 ? 'å¿…æ®ºæŠ€ (ã‚¿ãƒ¼ãƒ³æ¶ˆè²»)' : 'ä½¿ç”¨æ¸ˆã¿';
            document.getElementById('p2SpecialBtn').textContent = gameState.skillsAvailable.team2 ? 'å¿…æ®ºæŠ€ (ã‚¿ãƒ¼ãƒ³æ¶ˆè²»)' : 'ä½¿ç”¨æ¸ˆã¿';
        }
        function renderGrid() {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            grid.style.gridTemplateColumns = `repeat(${gameState.gridSize}, 1fr)`;
            for (let i = 0; i < gameState.gridSize; i++) {
                for (let j = 0; j < gameState.gridSize; j++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.dataset.row = i;
                    cell.dataset.col = j;
                    const cellData = gameState.grid[i][j];
                    if (cellData) {
                        cell.textContent = cellData.letter;
                        cell.classList.add('occupied');
                        if (cellData.team === 0) {
                            cell.classList.add('neutral');
                        } else {
                            cell.classList.add(`team${cellData.team}`);
                        }
                        if (gameState.specialPowerMode) {
                            const opponent = gameState.specialPlayerUsing === 1 ? 2 : 1;
                            if (cellData.team === opponent) {
                                cell.style.cursor = 'pointer';
                                cell.onclick = () => convertCell(i, j);
                            }
                        }
                    } else {
                        if (!gameState.specialPowerMode) {
                            cell.onclick = () => placeCell(i, j);
                        }
                    }
                    grid.appendChild(cell);
                }
            }
        }
        function placeCell(row, col) {
            if (!gameState.isGameActive || gameState.specialPowerMode) return;
            if (gameState.grid[row][col]) return;
            if (gameState.opponentMode === 'cpu' && gameState.currentPlayer === 2) return;
            const letter = gameState.selectedLetter[`team${gameState.currentPlayer}`];
            if (!letter) {
                showToast('æ–‡å­—ã‚’é¸æŠã—ã¦ãã ã•ã„', 'warning');
                return;
            }
            gameState.grid[row][col] = { letter: letter, team: gameState.currentPlayer };
            gameState.moveHistory.push({ row, col, letter: letter, team: gameState.currentPlayer });
            gameState.totalMoves++;
            updateCurrentSkill();
            const hadCompletion = calculateScores();
            renderGrid();
            updateAllUI();
            if (isBoardFull()) {
                endGame(compareScores());
                return;
            }
            if (hadCompletion && !gameState.bonusTurn) {
                gameState.bonusTurn = true;
                showToast('ğŸ‰ å®Œæˆï¼ã‚‚ã†1æ‰‹ç½®ã‘ã¾ã™ï¼', 'achievement');
                updateAllUI();
                return;
            }
            gameState.bonusTurn = false;
            if (gameState.difficulty === 'legend' && gameState.totalMoves % 5 === 0) {
                rotateGrid();
            }
            switchTurn();
            resetTurnTimer();
            updateAllUI();
            if (gameState.opponentMode === 'cpu' && gameState.currentPlayer === 2) {
                setTimeout(makeCPUMove, 1500);
            }
        }
        function makeCPUMove() {
            if (!gameState.isGameActive || gameState.currentPlayer !== 2) return;
            const emptySpots = [];
            for (let i = 0; i < gameState.gridSize; i++) {
                for (let j = 0; j < gameState.gridSize; j++) {
                    if (!gameState.grid[i][j]) {
                        emptySpots.push({ row: i, col: j });
                    }
                }
            }
            if (emptySpots.length === 0) {
                endGame(compareScores());
                return;
            }
            let spot, letter;
            if (gameState.cpuLevel === 1) {
                spot = emptySpots[Math.floor(Math.random() * emptySpots.length)];
                letter = gameState.availableLetters[Math.floor(Math.random() * gameState.availableLetters.length)];
            } else if (gameState.cpuLevel === 2) {
                const blockMove = findBlockingMove();
                if (blockMove && Math.random() < 0.75) {
                    spot = { row: blockMove.row, col: blockMove.col };
                    letter = blockMove.letter;
                } else {
                    spot = emptySpots[Math.floor(Math.random() * emptySpots.length)];
                    letter = gameState.availableLetters[Math.floor(Math.random() * gameState.availableLetters.length)];
                }
            } else {
                const attackMove = findBestAttackMove();
                if (attackMove && Math.random() < 0.85) {
                    spot = { row: attackMove.row, col: attackMove.col };
                    letter = attackMove.letter;
                } else {
                    const blockMove = findBlockingMove();
                    if (blockMove && Math.random() < 0.7) {
                        spot = { row: blockMove.row, col: blockMove.col };
                        letter = blockMove.letter;
                    } else {
                        spot = emptySpots[Math.floor(Math.random() * emptySpots.length)];
                        letter = gameState.availableLetters[Math.floor(Math.random() * gameState.availableLetters.length)];
                    }
                }
            }
            gameState.selectedLetter.team2 = letter;
            placeCell(spot.row, spot.col);
        }
        function findBlockingMove() {
            for (let i = 0; i < gameState.gridSize; i++) {
                for (let j = 0; j < gameState.gridSize; j++) {
                    if (!gameState.grid[i][j]) {
                        for (const letter of gameState.availableLetters) {
                            gameState.grid[i][j] = { letter, team: 1 };
                            const wouldComplete = checkIfCompletesPattern(1);
                            gameState.grid[i][j] = null;
                            if (wouldComplete) {
                                return { row: i, col: j, letter };
                            }
                        }
                    }
                }
            }
            return null;
        }
        function findBestAttackMove() {
            for (let i = 0; i < gameState.gridSize; i++) {
                for (let j = 0; j < gameState.gridSize; j++) {
                    if (!gameState.grid[i][j]) {
                        for (const letter of gameState.availableLetters) {
                            gameState.grid[i][j] = { letter, team: 2 };
                            const wouldComplete = checkIfCompletesPattern(2);
                            gameState.grid[i][j] = null;
                            if (wouldComplete) {
                                return { row: i, col: j, letter };
                            }
                        }
                    }
                }
            }
            return null;
        }
        function checkIfCompletesPattern(team) {
            for (let i = 0; i < gameState.gridSize; i++) {
                for (let j = 0; j <= gameState.gridSize - 4; j++) {
                    if (checkPatternAtPosition(i, j, 0, 1, team)) return true;
                }
            }
            for (let i = 0; i <= gameState.gridSize - 4; i++) {
                for (let j = 0; j < gameState.gridSize; j++) {
                    if (checkPatternAtPosition(i, j, 1, 0, team)) return true;
                }
            }
            for (let i = 0; i <= gameState.gridSize - 4; i++) {
                for (let j = 0; j <= gameState.gridSize - 4; j++) {
                    if (checkPatternAtPosition(i, j, 1, 1, team)) return true;
                }
            }
            for (let i = 0; i <= gameState.gridSize - 4; i++) {
                for (let j = 3; j < gameState.gridSize; j++) {
                    if (checkPatternAtPosition(i, j, 1, -1, team)) return true;
                }
            }
            return false;
        }
        function checkPatternAtPosition(startRow, startCol, rowInc, colInc, team) {
            const positions = [];
            for (let k = 0; k < 7; k++) {
                const r = startRow + k * rowInc;
                const c = startCol + k * colInc;
                if (r >= 0 && r < gameState.gridSize && c >= 0 && c < gameState.gridSize) {
                    positions.push(gameState.grid[r][c]);
                } else {
                    break;
                }
            }
            if (positions.length < 3) return false;
            if (gameState.difficulty === 'ultimate' && positions.length >= 7) {
                const str = positions.map(p => p ? p.letter : '').join('');
                if ((str === 'NOGUCHI' || str === 'IHCUGON') && positions.every(p => p && (p.team === team || p.team === 0))) {
                    return true;
                }
            }
            for (let i = 0; i <= positions.length - 4; i++) {
                const fourPos = positions.slice(i, i + 4);
                if (fourPos.every(p => p !== null)) {
                    const str = fourPos.map(p => p.letter).join('');
                    if (fourPos.every(p => p.team === team || p.team === 0)) {
                        if (str === 'TAKA' || str === 'AKAT') return true;
                    }
                }
            }
            for (let i = 0; i <= positions.length - 3; i++) {
                const threePos = positions.slice(i, i + 3);
                if (threePos.every(p => p !== null)) {
                    const str = threePos.map(p => p.letter).join('');
                    if (threePos.every(p => p.team === team || p.team === 0)) {
                        if (str === 'TAK' || str === 'KAT') return true;
                    }
                }
            }
            return false;
        }
        function calculateScores() {
            const newScores = { team1: { main: 0, sub: 0, noguchi: 0 }, team2: { main: 0, sub: 0, noguchi: 0 } };
            const newCompletedPatterns = [];
            let hadNewCompletion = false;
            for (let i = 0; i < gameState.gridSize; i++) {
                for (let j = 0; j <= gameState.gridSize - 3; j++) {
                    const result = checkPatternInDirection(i, j, 0, 1, newScores, newCompletedPatterns);
                    if (result) hadNewCompletion = true;
                }
            }
            for (let i = 0; i <= gameState.gridSize - 3; i++) {
                for (let j = 0; j < gameState.gridSize; j++) {
                    const result = checkPatternInDirection(i, j, 1, 0, newScores, newCompletedPatterns);
                    if (result) hadNewCompletion = true;
                }
            }
            for (let i = 0; i <= gameState.gridSize - 3; i++) {
                for (let j = 0; j <= gameState.gridSize - 3; j++) {
                    const result = checkPatternInDirection(i, j, 1, 1, newScores, newCompletedPatterns);
                    if (result) hadNewCompletion = true;
                }
            }
            for (let i = 0; i <= gameState.gridSize - 3; i++) {
                for (let j = 3; j < gameState.gridSize; j++) {
                    const result = checkPatternInDirection(i, j, 1, -1, newScores, newCompletedPatterns);
                    if (result) hadNewCompletion = true;
                }
            }
            gameState.scores = newScores;
            const wasNew = newCompletedPatterns.length > gameState.completedPatterns.length;
            gameState.completedPatterns = newCompletedPatterns;
            return wasNew && hadNewCompletion;
        }
        function checkPatternInDirection(startRow, startCol, rowInc, colInc, scores, patterns) {
            const positions = [];
            for (let k = 0; k < 7; k++) {
                const r = startRow + k * rowInc;
                const c = startCol + k * colInc;
                if (r >= 0 && r < gameState.gridSize && c >= 0 && c < gameState.gridSize) {
                    positions.push({ cell: gameState.grid[r][c], row: r, col: c });
                } else {
                    break;
                }
            }
            if (positions.length < 3) return false;
            let found = false;
            if (gameState.difficulty === 'ultimate' && positions.length >= 7) {
                const str = positions.map(p => p.cell ? p.cell.letter : '').join('');
                if (str === 'NOGUCHI' || str === 'IHCUGON') {
                    const team = positions[0].cell.team;
                    if (team > 0 && positions.every(p => p.cell && (p.cell.team === team || p.cell.team === 0))) {
                        const patternKey = `${startRow}-${startCol}-${rowInc}-${colInc}-NOGUCHI-${team}`;
                        if (!patterns.includes(patternKey)) {
                            scores[`team${team}`].noguchi++;
                            patterns.push(patternKey);
                            found = true;
                        }
                    }
                }
            }
            for (let i = 0; i <= positions.length - 4; i++) {
                const fourPos = positions.slice(i, i + 4);
                if (fourPos.every(p => p.cell !== null)) {
                    const str = fourPos.map(p => p.cell.letter).join('');
                    const team = fourPos[0].cell.team;
                    if (team > 0 && fourPos.every(p => p.cell.team === team || p.cell.team === 0)) {
                        if (str === 'TAKA' || str === 'AKAT') {
                            const patternKey = `${fourPos[0].row}-${fourPos[0].col}-${rowInc}-${colInc}-${str}-${team}`;
                            if (!patterns.includes(patternKey)) {
                                scores[`team${team}`].main++;
                                patterns.push(patternKey);
                                found = true;
                            }
                        }
                    }
                }
            }
            for (let i = 0; i <= positions.length - 3; i++) {
                const threePos = positions.slice(i, i + 3);
                if (threePos.every(p => p.cell !== null)) {
                    const str = threePos.map(p => p.cell.letter).join('');
                    const team = threePos[0].cell.team;
                    if (team > 0 && threePos.every(p => p.cell.team === team || p.cell.team === 0)) {
                        if (str === 'TAK' || str === 'KAT') {
                            const patternKey = `${threePos[0].row}-${threePos[0].col}-${rowInc}-${colInc}-${str}-${team}`;
                            if (!patterns.includes(patternKey)) {
                                scores[`team${team}`].sub++;
                                patterns.push(patternKey);
                                found = true;
                            }
                        }
                    }
                }
            }
            return found;
        }
        function useSpecialPower(player) {
            const playerKey = `team${player}`;
            if (!gameState.skillsAvailable[playerKey]) {
                showToast('å¿…æ®ºæŠ€ã¯æ—¢ã«ä½¿ç”¨æ¸ˆã¿ã§ã™', 'warning');
                return;
            }
            if (gameState.currentSkill.effect === 'convert') {
                gameState.specialPowerMode = true;
                gameState.specialPlayerUsing = player;
                gameState.skillsAvailable[playerKey] = false;
                document.getElementById('specialDescription').textContent = 'ç›¸æ‰‹ã®é§’ã‚’é¸ã‚“ã§ãã ã•ã„';
                document.getElementById('specialEffect').innerHTML = 'é¸ã‚“ã é§’ãŒã‚ãªãŸã®é§’ã«å¤‰ã‚ã‚Šã¾ã™ï¼<br>â€»æŠ€ä½¿ç”¨å¾Œã¯ç›¸æ‰‹ã®ã‚¿ãƒ¼ãƒ³ã«ãªã‚Šã¾ã™';
                document.getElementById('specialModal').classList.add('active');
                renderGrid();
                showToast('ç›¸æ‰‹ã®é§’ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å¤‰æ›ï¼', 'info');
            }
            updateCurrentSkill();
        }
        function convertCell(row, col) {
            if (!gameState.specialPowerMode) return;
            const cell = gameState.grid[row][col];
            if (!cell) return;
            const opponent = gameState.specialPlayerUsing === 1 ? 2 : 1;
            if (cell.team !== opponent) return;
            gameState.grid[row][col].team = gameState.specialPlayerUsing;
            gameState.specialPowerMode = false;
            closeSpecialModal();
            calculateScores();
            renderGrid();
            updateAllUI();
            showToast('é§’ã‚’å¤‰æ›ã—ã¾ã—ãŸï¼', 'achievement');
            switchTurn();
            gameState.specialPlayerUsing = 0;
            resetTurnTimer();
            updateAllUI();
            if (gameState.opponentMode === 'cpu' && gameState.currentPlayer === 2) {
                setTimeout(makeCPUMove, 1500);
            }
        }
        function closeSpecialModal() {
            document.getElementById('specialModal').classList.remove('active');
            gameState.specialPowerMode = false;
            gameState.specialPlayerUsing = 0;
            renderGrid();
        }
        function showAdvancedHint() {
            const hintPanel = document.getElementById('hintPanel');
            const hintContent = document.getElementById('hintContent');
            gameState.hintVisible = !gameState.hintVisible;
            hintPanel.style.display = gameState.hintVisible ? 'block' : 'none';
            if (!gameState.hintVisible) return;
            const hints = [];
            const currentTeam = gameState.currentPlayer;
            for (let i = 0; i < gameState.gridSize; i++) {
                for (let j = 0; j < gameState.gridSize; j++) {
                    if (!gameState.grid[i][j]) {
                        for (const letter of gameState.availableLetters) {
                            gameState.grid[i][j] = { letter, team: currentTeam };
                            const wouldComplete = checkIfCompletesPattern(currentTeam);
                            gameState.grid[i][j] = null;
                            if (wouldComplete) {
                                hints.push({ type: 'ğŸ¯ å®Œæˆå¯èƒ½', text: `(${i+1}, ${j+1})ã«ã€Œ${letter}ã€ã‚’ç½®ãã¨å®Œæˆã—ã¾ã™ï¼`, priority: 3 });
                            }
                        }
                    }
                }
            }
            const opponent = currentTeam === 1 ? 2 : 1;
            for (let i = 0; i < gameState.gridSize; i++) {
                for (let j = 0; j < gameState.gridSize; j++) {
                    if (!gameState.grid[i][j]) {
                        for (const letter of gameState.availableLetters) {
                            gameState.grid[i][j] = { letter, team: opponent };
                            const wouldComplete = checkIfCompletesPattern(opponent);
                            gameState.grid[i][j] = null;
                            if (wouldComplete) {
                                hints.push({ type: 'ğŸ›¡ï¸ é˜²å¾¡æ¨å¥¨', text: `(${i+1}, ${j+1})ã‚’é˜»æ­¢ã—ãªã„ã¨ç›¸æ‰‹ãŒå®Œæˆã—ã¾ã™`, priority: 2 });
                                break;
                            }
                        }
                    }
                }
            }
            hints.push({ type: 'ğŸ’¡ æˆ¦ç•¥', text: 'ä¸­å¤®ã®å…±ç”¨Tã‚’æ´»ç”¨ã™ã‚‹ã¨æœ‰åˆ©ã§ã™', priority: 1 });
            hints.push({ type: 'âš¡ æŠ€', text: `ç¾åœ¨ã®æŠ€: ${gameState.currentSkill.name} - åŠ¹æœçš„ã«ä½¿ã„ã¾ã—ã‚‡ã†ï¼ˆã‚¿ãƒ¼ãƒ³æ¶ˆè²»ã«æ³¨æ„ï¼‰`, priority: 1 });
            hints.sort((a, b) => b.priority - a.priority);
            const selectedHints = hints.slice(0, 5);
            hintContent.innerHTML = selectedHints.map(h => `<div class="hint-item"><strong>${h.type}:</strong> ${h.text}</div>`).join('');
        }
        function rotateGrid() {
            const newGrid = Array(gameState.gridSize).fill().map(() => Array(gameState.gridSize).fill(null));
            for (let i = 0; i < gameState.gridSize; i++) {
                for (let j = 0; j < gameState.gridSize; j++) {
                    newGrid[j][gameState.gridSize - 1 - i] = gameState.grid[i][j];
                }
            }
            gameState.grid = newGrid;
            gameState.rotationCount++;
            calculateScores();
            renderGrid();
            showToast('ğŸ”„ ç›¤é¢ãŒ90åº¦å›è»¢ã—ã¾ã—ãŸï¼', 'achievement');
        }
        function switchTurn() {
            gameState.currentPlayer = gameState.currentPlayer === 1 ? 2 : 1;
            const currentPeriod = Math.floor(gameState.totalMoves / 7);
            if (gameState.totalMoves % 7 === 0) {
                gameState.skillsAvailable.team1 = true;
                gameState.skillsAvailable.team2 = true;
            }
        }
        function isBoardFull() {
            return gameState.grid.every(row => row.every(cell => cell !== null));
        }
        function startMatchTimer() {
            gameState.matchTimeRemaining = gameState.matchTimeLimit;
            updateTimerDisplay();
            gameState.matchTimerInterval = setInterval(() => {
                gameState.matchTimeRemaining--;
                updateTimerDisplay();
                if (gameState.matchTimeRemaining <= 30) {
                    document.getElementById('timerDisplay').classList.add('warning');
                }
                if (gameState.matchTimeRemaining <= 0) {
                    clearInterval(gameState.matchTimerInterval);
                    endGame(compareScores());
                }
            }, 1000);
        }
        function startTurnTimer() {
            resetTurnTimer();
        }
        function resetTurnTimer() {
            if (gameState.turnTimerInterval) {
                clearInterval(gameState.turnTimerInterval);
            }
            if (gameState.turnTimeLimit <= 0) return;
            gameState.turnTimeRemaining = gameState.turnTimeLimit;
            updateTimerDisplay();
            gameState.turnTimerInterval = setInterval(() => {
                gameState.turnTimeRemaining--;
                updateTimerDisplay();
                if (gameState.turnTimeRemaining <= 0) {
                    clearInterval(gameState.turnTimerInterval);
                    switchTurn();
                    resetTurnTimer();
                    updateAllUI();
                    showToast('æ™‚é–“åˆ‡ã‚Œï¼ã‚¿ãƒ¼ãƒ³ã‚¹ã‚­ãƒƒãƒ—', 'warning');
                    if (gameState.opponentMode === 'cpu' && gameState.currentPlayer === 2) {
                        setTimeout(makeCPUMove, 1000);
                    }
                }
            }, 1000);
        }
        function stopAllTimers() {
            if (gameState.matchTimerInterval) clearInterval(gameState.matchTimerInterval);
            if (gameState.turnTimerInterval) clearInterval(gameState.turnTimerInterval);
        }
        function updateTimerDisplay() {
            if (gameState.matchTimeLimit > 0) {
                const mins = Math.floor(gameState.matchTimeRemaining / 60);
                const secs = gameState.matchTimeRemaining % 60;
                document.getElementById('matchTimer').textContent = `${mins}:${String(secs).padStart(2, '0')}`;
            } else {
                document.getElementById('matchTimer').textContent = 'âˆ';
            }
            if (gameState.turnTimeLimit > 0) {
                document.getElementById('turnTimer').textContent = `${gameState.turnTimeRemaining}ç§’`;
            } else {
                document.getElementById('turnTimer').textContent = 'âˆ';
            }
        }
        function compareScores() {
            const p1Score = gameState.scores.team1.main * 3 + gameState.scores.team1.sub + gameState.scores.team1.noguchi * 5;
            const p2Score = gameState.scores.team2.main * 3 + gameState.scores.team2.sub + gameState.scores.team2.noguchi * 5;
            if (p1Score > p2Score) return { winner: 1, reason: 'ã‚¹ã‚³ã‚¢å„ªä½' };
            if (p2Score > p1Score) return { winner: 2, reason: 'ã‚¹ã‚³ã‚¢å„ªä½' };
            return { winner: 0, reason: 'å¼•ãåˆ†ã‘' };
        }
        function updateAllUI() {
            document.getElementById('team1Display').textContent = gameState.team1Name;
            document.getElementById('team2Display').textContent = gameState.team2Name;
            document.getElementById('team1SelectorTitle').textContent = gameState.team1Name;
            document.getElementById('team2SelectorTitle').textContent = gameState.team2Name;
            const p1Main = gameState.scores.team1.main;
            const p1Sub = gameState.scores.team1.sub;
            const p1Nog = gameState.scores.team1.noguchi;
            const p2Main = gameState.scores.team2.main;
            const p2Sub = gameState.scores.team2.sub;
            const p2Nog = gameState.scores.team2.noguchi;
            document.getElementById('p1Taka').textContent = p1Main;
            document.getElementById('p1Tak').textContent = p1Sub;
            document.getElementById('p1Noguchi').textContent = p1Nog;
            document.getElementById('p1Total').textContent = p1Main * 3 + p1Sub + p1Nog * 5;
            document.getElementById('p2Taka').textContent = p2Main;
            document.getElementById('p2Tak').textContent = p2Sub;
            document.getElementById('p2Noguchi').textContent = p2Nog;
            document.getElementById('p2Total').textContent = p2Main * 3 + p2Sub + p2Nog * 5;
            const playerName = gameState.currentPlayer === 1 ? gameState.team1Name : gameState.team2Name;
            document.getElementById('currentPlayerName').textContent = playerName;
            document.getElementById('player1Info').classList.toggle('active-player', gameState.currentPlayer === 1);
            document.getElementById('player2Info').classList.toggle('active-player', gameState.currentPlayer === 2);
            updateLetterSelectors();
            updateCurrentSkill();
            document.getElementById('undoBtn').disabled = gameState.moveHistory.length === 0;
            renderGrid();
        }
        function updateLetterSelectors() {
            const selector1 = document.getElementById('letterSelector1');
            selector1.innerHTML = `<h4 id="team1SelectorTitle">${gameState.team1Name}</h4>`;
            gameState.availableLetters.forEach(letter => {
                const btn = document.createElement('button');
                btn.className = 'letter-btn';
                btn.textContent = letter;
                btn.onclick = () => selectLetter(1, letter);
                if (gameState.selectedLetter.team1 === letter) {
                    btn.classList.add('selected');
                }
                btn.disabled = gameState.currentPlayer !== 1;
                selector1.appendChild(btn);
            });
            const selector2 = document.getElementById('letterSelector2');
            selector2.innerHTML = `<h4 id="team2SelectorTitle">${gameState.team2Name}</h4>`;
            gameState.availableLetters.forEach(letter => {
                const btn = document.createElement('button');
                btn.className = 'letter-btn';
                btn.textContent = letter;
                btn.onclick = () => selectLetter(2, letter);
                if (gameState.selectedLetter.team2 === letter) {
                    btn.classList.add('selected');
                }
                btn.disabled = gameState.currentPlayer !== 2 || gameState.opponentMode === 'cpu';
                selector2.appendChild(btn);
            });
        }
        function selectLetter(player, letter) {
            gameState.selectedLetter[`team${player}`] = letter;
            updateLetterSelectors();
        }
        function undoMove() {
            if (gameState.moveHistory.length === 0) return;
            const lastMove = gameState.moveHistory.pop();
            gameState.grid[lastMove.row][lastMove.col] = null;
            const center = Math.floor(gameState.gridSize / 2);
            if (lastMove.row === center && lastMove.col === center) {
                gameState.grid[center][center] = { letter: 'T', team: 0 };
            }
            gameState.currentPlayer = lastMove.team;
            gameState.totalMoves--;
            calculateScores();
            updateAllUI();
            showToast('1æ‰‹æˆ»ã—ã¾ã—ãŸ', 'success');
        }
        function confirmEndGame() {
            if (confirm('ã‚²ãƒ¼ãƒ ã‚’çµ‚äº†ã—ã¾ã™ã‹ï¼Ÿç¾åœ¨ã®ãƒã‚¤ãƒ³ãƒˆã§å‹æ•—ãŒæ±ºã¾ã‚Šã¾ã™ã€‚')) {
                endGame(compareScores());
            }
        }
        function backToMenu() {
            if (gameState.isGameActive) {
                if (!confirm('é€²è¡Œä¸­ã®ã‚²ãƒ¼ãƒ ã‚’çµ‚äº†ã—ã¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ')) {
                    return;
                }
            }
            stopAllTimers();
            closeModal();
            showScreen('menuScreen');
        }
        function restartGame() {
            closeModal();
            showScreen('settingsScreen');
        }
        function endGame(result) {
            gameState.isGameActive = false;
            stopAllTimers();
            const modal = document.getElementById('resultModal');
            const title = document.getElementById('resultTitle');
            const message = document.getElementById('resultMessage');
            const details = document.getElementById('resultDetails');
            if (result.winner === 0) {
                title.textContent = 'å¼•ãåˆ†ã‘ï¼';
                message.textContent = result.reason;
            } else if (result.winner === 1) {
                title.textContent = `${gameState.team1Name} ã®å‹åˆ©ï¼ğŸ‰`;
                message.textContent = result.reason;
            } else if (result.winner === 2) {
                const p2Name = gameState.opponentMode === 'cpu' ? `CPU (Lv.${gameState.cpuLevel})` : gameState.team2Name;
                title.textContent = `${p2Name} ã®å‹åˆ©ï¼ğŸ‰`;
                message.textContent = result.reason;
            }
            const p1Main = gameState.scores.team1.main;
            const p1Sub = gameState.scores.team1.sub;
            const p1Nog = gameState.scores.team1.noguchi;
            const p2Main = gameState.scores.team2.main;
            const p2Sub = gameState.scores.team2.sub;
            const p2Nog = gameState.scores.team2.noguchi;
            let detailsHTML = `
                <div style="font-size: 1.2em; line-height: 2;">
                    <p><strong>${gameState.team1Name}:</strong> ${p1Main * 3 + p1Sub + p1Nog * 5}ãƒã‚¤ãƒ³ãƒˆ</p>
                    <p style="font-size: 0.9em; margin-left: 20px;">TAKA/AKAT: ${p1Main} (${p1Main * 3}pt) | TAK/KAT: ${p1Sub} (${p1Sub}pt)`;
            if (gameState.difficulty === 'ultimate') {
                detailsHTML += ` | NOGUCHI: ${p1Nog} (${p1Nog * 5}pt)`;
            }
            detailsHTML += `</p>
                    <p><strong>${gameState.team2Name}:</strong> ${p2Main * 3 + p2Sub + p2Nog * 5}ãƒã‚¤ãƒ³ãƒˆ</p>
                    <p style="font-size: 0.9em; margin-left: 20px;">TAKA/AKAT: ${p2Main} (${p2Main * 3}pt) | TAK/KAT: ${p2Sub} (${p2Sub}pt)`;
            if (gameState.difficulty === 'ultimate') {
                detailsHTML += ` | NOGUCHI: ${p2Nog} (${p2Nog * 5}pt)`;
            }
            detailsHTML += `</p>
                    <p><strong>ç·æ‰‹æ•°:</strong> ${gameState.totalMoves}</p>
                </div>
            `;
            details.innerHTML = detailsHTML;
            modal.classList.add('active');
        }
        function closeModal() {
            document.getElementById('resultModal').classList.remove('active');
        }
        function saveGame() {
            const saveData = { ...gameState, timestamp: new Date().toISOString() };
            localStorage.setItem('takagame_v4_save', JSON.stringify(saveData));
            showToast('ã‚²ãƒ¼ãƒ ã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
        }
        function loadGame() {
            const data = localStorage.getItem('takagame_v4_save');
            if (!data) {
                showToast('ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'warning');
                return;
            }
            const saveData = JSON.parse(data);
            Object.assign(gameState, saveData);
            showScreen('gameScreen');
            updateAllUI();
            if (gameState.matchTimeLimit > 0) {
                startMatchTimer();
            }
            if (gameState.turnTimeLimit > 0) {
                startTurnTimer();
            }
            showToast('ã‚²ãƒ¼ãƒ ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ', 'success');
        }
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        console.log('TAKA GAME v4.0 Complete - All Bugs Fixed!');
    </script>
</body>
</html>
