<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TimeX v4.0 - å­¦ç¿’æ™‚é–“ç®¡ç†</title>
    <link rel="icon" href="TimeXicon.jpg">
    <style>
        :root { --primary: #667eea; --secondary: #4ecdc4; --accent: #f093fb; --gold: #ffd700; --dark-bg: #0a0a0a; --dark-card: #1a1a2e; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; min-height: 100vh; }
        #logoScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%); display: flex; justify-content: center; align-items: center; z-index: 10000; transition: opacity 1s ease; }
        #logoScreen.hide { opacity: 0; pointer-events: none; }
        .logo-content { text-align: center; animation: logoFadeIn 1.5s ease-out; }
        .logo-img { max-width: 90%; max-height: 70vh; object-fit: contain; filter: drop-shadow(0 20px 60px rgba(0, 0, 0, 0.5)); }
        @keyframes logoFadeIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
        #backButton { position: fixed; top: 20px; left: 20px; background: rgba(0, 0, 0, 0.5); color: white; border: 2px solid rgba(255, 255, 255, 0.3); padding: 12px 25px; border-radius: 50px; cursor: pointer; font-size: 1.1em; z-index: 1000; transition: all 0.3s ease; }
        #backButton:hover { background: rgba(255, 255, 255, 0.2); transform: scale(1.05); }
        .container { max-width: 1400px; margin: 0 auto; padding: 80px 20px 40px; }
        .header { text-align: center; margin-bottom: 40px; }
        .game-logo-img { max-width: 400px; width: 90%; margin: 0 auto 20px; filter: drop-shadow(0 10px 40px rgba(0, 0, 0, 0.3)); }
        .tabs { display: flex; gap: 15px; justify-content: center; margin: 30px 0; flex-wrap: wrap; }
        .tab-btn { padding: 15px 35px; background: rgba(255, 255, 255, 0.15); border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 15px; color: white; font-size: 1.2em; font-weight: bold; cursor: pointer; transition: all 0.3s ease; }
        .tab-btn:hover { background: rgba(255, 255, 255, 0.25); transform: scale(1.05); }
        .tab-btn.active { background: linear-gradient(135deg, var(--gold) 0%, #ffa500 100%); border-color: var(--gold); color: #333; box-shadow: 0 8px 25px rgba(255, 215, 0, 0.4); }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .study-section { background: rgba(0, 0, 0, 0.3); padding: 40px; border-radius: 20px; margin-bottom: 30px; }
        .study-section h2 { font-size: 2.2em; margin-bottom: 25px; text-align: center; }
        .timer-display { text-align: center; margin: 30px 0; }
        .timer { font-size: 6em; font-weight: bold; font-family: 'Courier New', monospace; margin: 20px 0; text-shadow: 0 4px 15px rgba(0, 0, 0, 0.5); }
        .study-controls { display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; margin-top: 25px; }
        .control-btn { padding: 15px 40px; border: none; border-radius: 12px; font-size: 1.2em; font-weight: bold; cursor: pointer; transition: all 0.3s ease; color: white; }
        .btn-start { background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%); }
        .btn-pause { background: linear-gradient(135deg, #ffa500 0%, #ff6b6b 100%); }
        .btn-reset { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .btn-settings { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .btn-complete { background: linear-gradient(135deg, var(--gold) 0%, #ffa500 100%); color: #333; }
        .control-btn:hover { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3); }
        .subject-input { margin-top: 25px; text-align: center; }
        .subject-input input { padding: 15px 20px; font-size: 1.1em; border-radius: 10px; border: 2px solid rgba(255, 255, 255, 0.3); background: rgba(255, 255, 255, 0.1); color: white; width: 300px; }
        .subject-input input::placeholder { color: rgba(255, 255, 255, 0.6); }
        .subject-input input:focus { outline: none; border-color: var(--gold); }
        .focus-mode { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); padding: 30px; border-radius: 15px; margin: 25px 0; border: 3px solid var(--accent); }
        .focus-title { font-size: 2.5em; text-align: center; margin-bottom: 15px; color: var(--gold); }
        .focus-subject { font-size: 1.5em; text-align: center; margin-bottom: 20px; color: rgba(255, 255, 255, 0.9); }
        .history-section { background: rgba(0, 0, 0, 0.3); padding: 40px; border-radius: 20px; }
        .history-controls { display: flex; gap: 15px; justify-content: center; align-items: center; margin-bottom: 30px; flex-wrap: wrap; }
        .week-selector { display: flex; gap: 10px; align-items: center; }
        .week-selector label { font-size: 1.2em; font-weight: bold; }
        .week-selector select, .week-selector input { padding: 10px 15px; font-size: 1.1em; border-radius: 8px; border: 2px solid rgba(255, 255, 255, 0.3); background: rgba(255, 255, 255, 0.1); color: white; }
        .week-selector select option { background: #1a1a2e; }
        .history-list { max-height: 500px; overflow-y: auto; }
        .history-item { background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 12px; margin: 15px 0; border-left: 5px solid var(--secondary); transition: all 0.3s ease; }
        .history-item:hover { background: rgba(255, 255, 255, 0.15); transform: translateX(5px); }
        .history-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .history-date { font-size: 1.1em; font-weight: bold; }
        .history-duration { font-size: 1.3em; color: var(--gold); font-weight: bold; }
        .history-subject { font-size: 1em; color: rgba(255, 255, 255, 0.8); }
        .history-delete-btn { padding: 8px 15px; background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); border: none; border-radius: 8px; color: white; cursor: pointer; font-size: 0.9em; transition: all 0.3s ease; }
        .history-delete-btn:hover { transform: scale(1.05); box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4); }
        .charts-section { background: rgba(0, 0, 0, 0.3); padding: 40px; border-radius: 20px; }
        .chart-container { background: rgba(255, 255, 255, 0.1); padding: 30px; border-radius: 15px; margin: 25px 0; }
        .chart-title { font-size: 1.8em; text-align: center; margin-bottom: 20px; color: var(--gold); }
        canvas { max-width: 100%; height: auto; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: rgba(0, 0, 0, 0.9); z-index: 5000; justify-content: center; align-items: center; }
        .modal.active { display: flex; animation: fadeIn 0.3s ease-out; }
        .modal-content { background: linear-gradient(135deg, var(--dark-card) 0%, #16213e 100%); padding: 45px; border-radius: 30px; max-width: 600px; width: 90%; box-shadow: 0 30px 80px rgba(0, 0, 0, 0.7); border: 3px solid var(--gold); }
        .modal-content h2 { font-size: 2.5em; text-align: center; margin-bottom: 25px; color: var(--gold); }
        .setting-group { margin: 20px 0; }
        .setting-group label { display: block; font-size: 1.2em; font-weight: bold; margin-bottom: 10px; }
        .setting-group input[type="number"] { width: 100%; padding: 12px; font-size: 1.1em; border-radius: 8px; border: 2px solid rgba(255, 255, 255, 0.3); background: rgba(255, 255, 255, 0.1); color: white; }
        .setting-group input:focus { outline: none; border-color: var(--gold); }
        .modal-buttons { display: flex; gap: 15px; margin-top: 30px; }
        .modal-btn { flex: 1; padding: 15px; border: none; border-radius: 12px; font-size: 1.2em; font-weight: bold; cursor: pointer; transition: all 0.3s ease; color: white; }
        .btn-primary { background: linear-gradient(135deg, var(--gold) 0%, #ffa500 100%); color: #333; }
        .btn-secondary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .modal-btn:hover { transform: scale(1.05); }
        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(150px); background: rgba(0, 0, 0, 0.9); color: white; padding: 18px 35px; border-radius: 50px; font-size: 1.1em; z-index: 6000; transition: transform 0.3s ease; border: 2px solid; }
        .toast.show { transform: translateX(-50%) translateY(0); }
        .toast.success { border-color: #56ab2f; }
        .toast.warning { border-color: #ffa500; }
        .toast.error { border-color: #ff6b6b; }
        .toast.info { border-color: #4ecdc4; }
        @media (max-width: 768px) {
            .timer { font-size: 4em; }
            .control-btn { font-size: 1em; padding: 12px 25px; }
            .tab-btn { padding: 12px 25px; font-size: 1em; }
        }
    </style>
</head>
<body>
    <div id="logoScreen">
        <div class="logo-content">
            <img src="TimeX.png" alt="TimeX" class="logo-img">
        </div>
    </div>
    <button id="backButton" onclick="window.location.href='index.html'">â† MeruHubã«æˆ»ã‚‹</button>
    <div class="container">
        <div class="header">
            <img src="TimeX.png" alt="TimeX" class="game-logo-img">
            <h1 style="font-size: 3em; margin-top: 15px;">TimeX v4.0</h1>
            <p style="font-size: 1.3em; margin-top: 10px; color: rgba(255, 255, 255, 0.8);">ã‚ãªãŸã®å­¦ç¿’æ™‚é–“ã‚’ç®¡ç†ãƒ»å¯è¦–åŒ–</p>
        </div>
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('timer')">â±ï¸ ã‚¿ã‚¤ãƒãƒ¼</button>
            <button class="tab-btn" onclick="switchTab('history')">ğŸ“‹ å±¥æ­´</button>
            <button class="tab-btn" onclick="switchTab('charts')">ğŸ“Š çµ±è¨ˆ</button>
        </div>
        <div id="timerTab" class="tab-content active">
            <div class="study-section">
                <h2>â±ï¸ å­¦ç¿’ã‚¿ã‚¤ãƒãƒ¼</h2>
                <div class="timer-display">
                    <div class="timer" id="timer">00:00:00</div>
                </div>
                <div class="subject-input">
                    <input type="text" id="subjectInput" placeholder="å‹‰å¼·ã™ã‚‹ç§‘ç›®ã‚’å…¥åŠ›ï¼ˆä¾‹ï¼šæ•°å­¦ï¼‰" />
                </div>
                <div class="study-controls">
                    <button class="control-btn btn-start" id="startBtn" onclick="startTimer()">â–¶ï¸ é–‹å§‹</button>
                    <button class="control-btn btn-pause" id="pauseBtn" onclick="pauseTimer()" disabled>â¸ï¸ ä¸€æ™‚åœæ­¢</button>
                    <button class="control-btn btn-reset" onclick="resetTimer()">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
                    <button class="control-btn btn-settings" onclick="openSettings()">âš™ï¸ è¨­å®š</button>
                    <button class="control-btn btn-complete" onclick="completeSession()">âœ… å®Œäº†</button>
                </div>
            </div>
            <div id="focusMode" class="focus-mode" style="display: none;">
                <div class="focus-title">ğŸ¯ é›†ä¸­ãƒ¢ãƒ¼ãƒ‰</div>
                <div class="focus-subject" id="focusSubjectDisplay">æ•°å­¦</div>
                <div class="timer-display">
                    <div class="timer" id="focusTimer">00:00:00</div>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="control-btn btn-pause" onclick="exitFocusMode()">â¬…ï¸ é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã«æˆ»ã‚‹</button>
                </div>
            </div>
        </div>
        <div id="historyTab" class="tab-content">
            <div class="history-section">
                <h2>ğŸ“‹ å­¦ç¿’å±¥æ­´</h2>
                <div class="history-controls">
                    <button class="control-btn btn-start" onclick="exportHistory()">ğŸ“¥ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                    <button class="control-btn btn-reset" onclick="clearAllHistory()">ğŸ—‘ï¸ å…¨å‰Šé™¤</button>
                </div>
                <div id="historyList" class="history-list"></div>
            </div>
        </div>
        <div id="chartsTab" class="tab-content">
            <div class="charts-section">
                <h2>ğŸ“Š å­¦ç¿’çµ±è¨ˆ</h2>
                <div class="week-selector">
                    <label>è¡¨ç¤ºæœŸé–“ï¼š</label>
                    <select id="periodType" onchange="updateChartsPeriod()">
                        <option value="week">é€±åˆ¥</option>
                        <option value="month">æœˆåˆ¥</option>
                    </select>
                    <input type="week" id="weekPicker" onchange="loadSelectedWeek()" />
                    <input type="month" id="monthPicker" onchange="loadSelectedMonth()" style="display:none;" />
                    <button class="control-btn btn-start" onclick="loadCurrentPeriod()">ğŸ“… ä»Šã‚’è¡¨ç¤º</button>
                </div>
                <div class="chart-container">
                    <div class="chart-title" id="weekChartTitle">ğŸ“Š ä»Šé€±ã®å­¦ç¿’æ™‚é–“</div>
                    <canvas id="weekChart"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title" id="monthChartTitle">ğŸ“Š ä»Šæœˆã®å­¦ç¿’æ™‚é–“</div>
                    <canvas id="monthChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <h2>âš™ï¸ ã‚¿ã‚¤ãƒãƒ¼è¨­å®š</h2>
            <div class="setting-group">
                <label>é›†ä¸­æ™‚é–“ (åˆ†)</label>
                <input type="number" id="focusMinutes" value="25" min="1" max="180" />
            </div>
            <div class="setting-group">
                <label>ä¼‘æ†©æ™‚é–“ (åˆ†)</label>
                <input type="number" id="breakMinutes" value="5" min="1" max="60" />
            </div>
            <div class="modal-buttons">
                <button class="modal-btn btn-secondary" onclick="closeSettings()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="modal-btn btn-primary" onclick="saveSettings()">ä¿å­˜</button>
            </div>
        </div>
    </div>
    <div id="toast" class="toast"></div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let timerState = {
            seconds: 0,
            isRunning: false,
            isFocusMode: false,
            interval: null,
            currentSubject: '',
            studyRecords: [],
            settings: { focusMinutes: 25, breakMinutes: 5 }
        };
        let weekChart = null;
        let monthChart = null;
        window.addEventListener('load', function() {
            setTimeout(() => {
                document.getElementById('logoScreen').classList.add('hide');
            }, 2500);
            loadSettings();
            loadStudyRecords();
            initializeWeekPicker();
            loadCurrentPeriod();
            renderHistory();
        });
        function loadSettings() {
            const saved = localStorage.getItem('timex_settings');
            if (saved) {
                timerState.settings = JSON.parse(saved);
            }
        }
        function saveSettingsToStorage() {
            localStorage.setItem('timex_settings', JSON.stringify(timerState.settings));
        }
        function loadStudyRecords() {
            const saved = localStorage.getItem('timex_records');
            if (saved) {
                timerState.studyRecords = JSON.parse(saved);
            }
        }
        function saveStudyRecords() {
            localStorage.setItem('timex_records', JSON.stringify(timerState.studyRecords));
        }
        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(`${tabName}Tab`).classList.add('active');
            if (tabName === 'charts') {
                updateCharts();
            } else if (tabName === 'history') {
                renderHistory();
            }
        }
        function startTimer() {
            if (timerState.isRunning) return;
            const subject = document.getElementById('subjectInput').value.trim();
            if (!subject) {
                showToast('ç§‘ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
                return;
            }
            timerState.currentSubject = subject;
            timerState.isRunning = true;
            document.getElementById('startBtn').disabled = true;
            document.getElementById('pauseBtn').disabled = false;
            timerState.interval = setInterval(() => {
                timerState.seconds++;
                updateTimerDisplay();
            }, 1000);
            showToast('å­¦ç¿’ã‚’é–‹å§‹ã—ã¾ã—ãŸï¼', 'success');
        }
        function pauseTimer() {
            if (!timerState.isRunning) return;
            timerState.isRunning = false;
            document.getElementById('startBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
            clearInterval(timerState.interval);
            showToast('ä¸€æ™‚åœæ­¢ã—ã¾ã—ãŸ', 'info');
        }
        function resetTimer() {
            timerState.isRunning = false;
            timerState.seconds = 0;
            document.getElementById('startBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
            clearInterval(timerState.interval);
            updateTimerDisplay();
            showToast('ã‚¿ã‚¤ãƒãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ', 'info');
        }
        function completeSession() {
            if (timerState.seconds === 0) {
                showToast('å­¦ç¿’æ™‚é–“ã‚’è¨˜éŒ²ã§ãã¾ã›ã‚“', 'warning');
                return;
            }
            const record = {
                date: new Date().toISOString(),
                duration: timerState.seconds,
                subject: timerState.currentSubject || 'æœªè¨­å®š'
            };
            timerState.studyRecords.push(record);
            saveStudyRecords();
            showToast(`å­¦ç¿’ã‚’è¨˜éŒ²ã—ã¾ã—ãŸï¼ (${formatTime(timerState.seconds)})`, 'success');
            resetTimer();
            renderHistory();
        }
        function updateTimerDisplay() {
            const display = timerState.isFocusMode ? 'focusTimer' : 'timer';
            document.getElementById(display).textContent = formatTime(timerState.seconds);
        }
        function formatTime(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
        }
        function openSettings() {
            document.getElementById('focusMinutes').value = timerState.settings.focusMinutes;
            document.getElementById('breakMinutes').value = timerState.settings.breakMinutes;
            document.getElementById('settingsModal').classList.add('active');
        }
        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('active');
        }
        function saveSettings() {
            timerState.settings.focusMinutes = parseInt(document.getElementById('focusMinutes').value);
            timerState.settings.breakMinutes = parseInt(document.getElementById('breakMinutes').value);
            saveSettingsToStorage();
            closeSettings();
            showToast('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
        }
        function exitFocusMode() {
            timerState.isFocusMode = false;
            document.getElementById('focusMode').style.display = 'none';
        }
        function renderHistory() {
            const historyList = document.getElementById('historyList');
            if (timerState.studyRecords.length === 0) {
                historyList.innerHTML = '<p style="text-align: center; font-size: 1.2em; margin: 50px 0; color: rgba(255, 255, 255, 0.6);">ã¾ã å­¦ç¿’è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            const sortedRecords = [...timerState.studyRecords].reverse();
            historyList.innerHTML = sortedRecords.map((record, index) => {
                const date = new Date(record.date);
                const dateStr = `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
                return `
                    <div class="history-item">
                        <div class="history-item-header">
                            <div class="history-date">${dateStr}</div>
                            <div class="history-duration">${formatTime(record.duration)}</div>
                        </div>
                        <div class="history-subject">ğŸ“š ${record.subject}</div>
                        <button class="history-delete-btn" onclick="deleteRecord(${timerState.studyRecords.length - 1 - index})">ğŸ—‘ï¸ å‰Šé™¤</button>
                    </div>
                `;
            }).join('');
        }
        function deleteRecord(index) {
            if (confirm('ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                timerState.studyRecords.splice(index, 1);
                saveStudyRecords();
                renderHistory();
                updateCharts();
                showToast('è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
            }
        }
        function clearAllHistory() {
            if (confirm('ã™ã¹ã¦ã®å­¦ç¿’è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                timerState.studyRecords = [];
                saveStudyRecords();
                renderHistory();
                updateCharts();
                showToast('ã™ã¹ã¦ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
            }
        }
        function exportHistory() {
            if (timerState.studyRecords.length === 0) {
                showToast('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“', 'warning');
                return;
            }
            let csv = 'æ—¥æ™‚,ç§‘ç›®,å­¦ç¿’æ™‚é–“(ç§’)\n';
            timerState.studyRecords.forEach(record => {
                csv += `${record.date},${record.subject},${record.duration}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `timex_history_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('å±¥æ­´ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ', 'success');
        }
        function initializeWeekPicker() {
            const now = new Date();
            const weekStr = getWeekString(now);
            document.getElementById('weekPicker').value = weekStr;
            const monthStr = getMonthString(now);
            document.getElementById('monthPicker').value = monthStr;
        }
        function getWeekString(date) {
            const year = date.getFullYear();
            const startOfYear = new Date(year, 0, 1);
            const days = Math.floor((date - startOfYear) / (24 * 60 * 60 * 1000));
            const weekNumber = Math.ceil((days + startOfYear.getDay() + 1) / 7);
            return `${year}-W${String(weekNumber).padStart(2, '0')}`;
        }
        function getMonthString(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            return `${year}-${month}`;
        }
        function updateChartsPeriod() {
            const periodType = document.getElementById('periodType').value;
            if (periodType === 'week') {
                document.getElementById('weekPicker').style.display = 'inline-block';
                document.getElementById('monthPicker').style.display = 'none';
            } else {
                document.getElementById('weekPicker').style.display = 'none';
                document.getElementById('monthPicker').style.display = 'inline-block';
            }
            loadCurrentPeriod();
        }
        function loadCurrentPeriod() {
            const periodType = document.getElementById('periodType').value;
            if (periodType === 'week') {
                const now = new Date();
                document.getElementById('weekPicker').value = getWeekString(now);
                loadSelectedWeek();
            } else {
                const now = new Date();
                document.getElementById('monthPicker').value = getMonthString(now);
                loadSelectedMonth();
            }
        }
        function loadSelectedWeek() {
            const weekValue = document.getElementById('weekPicker').value;
            if (!weekValue) return;
            const [yearStr, weekStr] = weekValue.split('-W');
            const year = parseInt(yearStr);
            const week = parseInt(weekStr);
            const startDate = getDateOfISOWeek(week, year);
            const endDate = new Date(startDate);
            endDate.setDate(endDate.getDate() + 6);
            renderWeekChart(startDate, endDate, year, week);
        }
        function loadSelectedMonth() {
            const monthValue = document.getElementById('monthPicker').value;
            if (!monthValue) return;
            const [yearStr, monthStr] = monthValue.split('-');
            const year = parseInt(yearStr);
            const month = parseInt(monthStr);
            renderMonthChart(year, month);
        }
        function getDateOfISOWeek(w, y) {
            const simple = new Date(y, 0, 1 + (w - 1) * 7);
            const dow = simple.getDay();
            const ISOweekStart = simple;
            if (dow <= 4)
                ISOweekStart.setDate(simple.getDate() - simple.getDay() + 1);
            else
                ISOweekStart.setDate(simple.getDate() + 8 - simple.getDay());
            return ISOweekStart;
        }
        function updateCharts() {
            const periodType = document.getElementById('periodType').value;
            if (periodType === 'week') {
                loadSelectedWeek();
            } else {
                loadSelectedMonth();
            }
        }
        function renderWeekChart(startDate, endDate, year, week) {
            const labels = [];
            const data = [];
            for (let i = 0; i < 7; i++) {
                const date = new Date(startDate);
                date.setDate(date.getDate() + i);
                const dayNames = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
                labels.push(`${date.getMonth() + 1}/${date.getDate()} (${dayNames[date.getDay()]})`);
                const dayRecords = timerState.studyRecords.filter(record => {
                    const recordDate = new Date(record.date);
                    return recordDate.toDateString() === date.toDateString();
                });
                const totalMinutes = dayRecords.reduce((sum, record) => sum + record.duration / 60, 0);
                data.push(Math.round(totalMinutes));
            }
            document.getElementById('weekChartTitle').textContent = `ğŸ“Š ${year}å¹´ ç¬¬${week}é€±ã®å­¦ç¿’æ™‚é–“`;
            const ctx = document.getElementById('weekChart').getContext('2d');
            if (weekChart) {
                weekChart.destroy();
            }
            weekChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'å­¦ç¿’æ™‚é–“ (åˆ†)',
                        data: data,
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: {
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: { color: 'white', font: { size: 14 } }
                        }
                    }
                }
            });
            renderMonthChartForWeek(year, startDate.getMonth() + 1);
        }
        function renderMonthChart(year, month) {
            const daysInMonth = new Date(year, month, 0).getDate();
            const labels = [];
            const data = [];
            for (let week = 1; week <= Math.ceil(daysInMonth / 7); week++) {
                labels.push(`ç¬¬${week}é€±`);
                const weekStart = (week - 1) * 7 + 1;
                const weekEnd = Math.min(week * 7, daysInMonth);
                let weekTotal = 0;
                for (let day = weekStart; day <= weekEnd; day++) {
                    const date = new Date(year, month - 1, day);
                    const dayRecords = timerState.studyRecords.filter(record => {
                        const recordDate = new Date(record.date);
                        return recordDate.toDateString() === date.toDateString();
                    });
                    weekTotal += dayRecords.reduce((sum, record) => sum + record.duration / 60, 0);
                }
                data.push(Math.round(weekTotal));
            }
            const monthNames = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];
            document.getElementById('monthChartTitle').textContent = `ğŸ“Š ${year}å¹´${monthNames[month - 1]}ã®å­¦ç¿’æ™‚é–“`;
            const ctx = document.getElementById('monthChart').getContext('2d');
            if (monthChart) {
                monthChart.destroy();
            }
            monthChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'å­¦ç¿’æ™‚é–“ (åˆ†)',
                        data: data,
                        borderColor: 'rgba(78, 205, 196, 1)',
                        backgroundColor: 'rgba(78, 205, 196, 0.2)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: {
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: { color: 'white', font: { size: 14 } }
                        }
                    }
                }
            });
        }
        function renderMonthChartForWeek(year, month) {
            renderMonthChart(year, month);
        }
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        console.log('TimeX v4.0 - All Week Selection Complete!');
    </script>
</body>
</html>
